import re
import json
import requests
from collections import defaultdict
from datetime import datetime

log_file = input("Enter the path to the log file: ")
output_file = "parsed_results.txt"

SPLUNK_HEC_URL = "https://splunk.example.com:8088/services/collector"
SPLUNK_TOKEN = "HEC_TOKEN"

def send_to_splunk(event):
    headers = {
        "Authorization": f"Splunk {SPLUNK_TOKEN}"
    }
    payload = {
        "event": event
    }
    requests.post(SPLUNK_HEC_URL, headers=headers, data=json.dumps(payload), verify=False)

success_pattern = r"(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}).*User '(\w+)' logged in"
failed_pattern = r"(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}).*Failed login for user '(\w+)'"

failed_attempts = defaultdict(int)

with open(log_file, "r") as f, open(output_file, "w") as out:
    for line in f:
        success = re.search(success_pattern, line)
        failed = re.search(failed_pattern, line)

        if success:
            timestamp = success.group(1)
            username = success.group(2)

            event = {
                "type": "login_success",
                "user": username,
                "timestamp": timestamp
            }

            print(event)
            out.write(str(event) + "\n")
            send_to_splunk(event)

        if failed:
            timestamp = failed.group(1)
            username = failed.group(2)
            failed_attempts[username] += 1

            event = {
                "type": "login_failed",
                "user": username,
                "timestamp": timestamp
            }

            print(event)
            out.write(str(event) + "\n")
            send_to_splunk(event)

for user, count in failed_attempts.items():
    if count >= 5:
        event = {
            "type": "bruteforce_alert",
            "user": user,
            "failed_attempts": count
        }
        print(event)
        send_to_splunk(event)
